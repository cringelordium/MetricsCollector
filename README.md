# Metrics Collector

Система сбора и мониторинга метрик для приложений и системных ресурсов.

## Описание

Metrics Collector - это приложение для сбора, анализа и логирования различных системных и прикладных (IoT к примеру) метрик. Система поддерживает сбор метрик CPU, памяти, показов рекламы и HTTP-запросов с использованием современного C++и lock-free примитивов синхронизации (по крайней мере там где это возможно).

## Основные возможности

- Сбор CPU метрик (использование процессора)
- Мониторинг использования памяти
- Отслеживание показов рекламы
- Мониторинг HTTP-запросов
- Lock-free реализация для высокой производительности
- Автоматическое логирование метрик
- Статистическая симуляция метрик с реалистичными распределениями

## Требования

- C++20 или выше (нужно для ```std::atomic<double>```)
- CMake 3.10 или выше
- Компилятор с поддержкой C++20 (GCC, Clang)

## Быстрый старт

1. Клонируйте репозиторий:
```bash
git clone git@github.com:cringelordium/MetricsCollector.git
cd MetricsCollector
```

2. Соберите проект:
```bash
mkdir build
cd build
cmake ..
make
```

3. Запустите:
```bash
./metrics_collector
```

4. Проверьте собранные метрики:
```bash
cat metrics.log
```

5. Должно быть что-то такое:
```bash
2025-06-15 15:53:37.943 "CPU" 68.956947 "Memory Usage" 1610.380334 "ad_engagement" 133 "HTTP requests RPS" 151
2025-06-15 15:53:38.943 "CPU" 67.694427 "Memory Usage" 1875.422771 "ad_engagement" 93 "HTTP requests RPS" 134
2025-06-15 15:53:39.943 "CPU" 77.057566 "Memory Usage" 1489.097384 "ad_engagement" 96 "HTTP requests RPS" 145
2025-06-15 15:53:40.943 "CPU" 71.992461 "Memory Usage" 1712.191929 "ad_engagement" 83 "HTTP requests RPS" 178
2025-06-15 15:53:41.943 "CPU" 77.026465 "Memory Usage" 1192.936071 "ad_engagement" 104 "HTTP requests RPS" 104
2025-06-15 15:53:42.944 "CPU" 70.861988 "Memory Usage" 1515.035129 "ad_engagement" 92 "HTTP requests RPS" 187
2025-06-15 15:53:43.944 "CPU" 76.340247 "Memory Usage" 1454.102199 "ad_engagement" 119 "HTTP requests RPS" 153
2025-06-15 15:53:44.944 "CPU" 69.084258 "Memory Usage" 1911.753224 "ad_engagement" 94 "HTTP requests RPS" 207
2025-06-15 15:53:45.944 "CPU" 66.521691 "Memory Usage" 1337.195511 "ad_engagement" 97 "HTTP requests RPS" 115
2025-06-15 15:53:46.944 "CPU" 72.119137 "Memory Usage" 1578.745402 "ad_engagement" 87 "HTTP requests RPS" 153
```

## Структура проекта

```
MetricsCatcher
  src/
    core/         # Основные компоненты системы
    metrics/      # Реализации различных метрик
  include/        # Заголовочные файлы
    core/
    metrics/        
  tests/          # Тесты
  docs/           # Документация
```

## Документация

Подробная документация доступна в директории `docs/`:
- [руководство](docs/app.md)

## Разработка

### Добавление новых метрик

Для добавления новой метрики достаточно создать производный класс от ```Metric```.

### Запуск тестов

1. Запуск всех тестов:

```bash
./run_tests
```

Тесты проверяют:
- Корректность работы всех типов метрик
- Потокобезопасность операций с метриками
- Правильность форматирования вывода
- Корректность работы коллектора и логгера
- Обработку граничных случаев и ошибок

2. Запуск бенчмарков:

```bash
./BenchmarkTest
```

Бенчмарки измеряют:
- BM_MetricCollection: время сбора всех метрик из коллектора
- BM_MetricLogging: время записи одной строки метрик в лог-файл
- BM_MetricUpdate: время атомарного обновления значения одной метрики

Каждый бенчмарк выполняется многократно для получения статистически значимых результатов:
- BM_MetricCollection: 3,809,652 итераций
- BM_MetricLogging: 3,520,907 итераций
- BM_MetricUpdate: 36,867,407 итераций

### Результаты бенчмарков

Бенчмарки были запущены на системе со следующими характеристиками:

```bash
Run on (8 X 2100 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x4)
  L1 Instruction 64 KiB (x4)
  L2 Unified 512 KiB (x4)
  L3 Unified 4096 KiB (x1)
Load Average: 3.68, 2.83, 2.32

--------------------------------------------------------------
Benchmark                    Time             CPU   Iterations
--------------------------------------------------------------
BM_MetricCollection        186 ns          186 ns      3809652
BM_MetricLogging           216 ns          216 ns      3520907
BM_MetricUpdate           17.8 ns         17.8 ns     36867407

```

### Анализ результатов

Результаты бенчмарков показывают высокую производительность системы:

1. **Обновление метрик (17.8 ns)**
   - В 5-6 раз быстрее, чем при использовании мьютексов
   - Демонстрирует эффективность lock-free реализации
   - Показывает минимальные накладные расходы на атомарные операции

2. **Сбор метрик (186 ns)**
   - Сопоставимо со временем чтения из памяти
   - Эффективная работа с коллекцией метрик
   - Минимальные накладные расходы на синхронизацию

3. **Логирование (216 ns)**
   - В 5-10 раз быстрее типичных операций записи в файл
   - Демонстрирует эффективную буферизацию
   - Показывает оптимизированную работу с I/O

## TODO

- [ ] Нормальые тесты под тред санитайзером 
- [ ] Оптимизация производительности
- [ ] clang-format
- [ ] CI/CD (done)

## Docker

### Сборка образа
```bash
docker build -t metrics-collector .
```

### Запуск контейнера
```bash
docker run -v $(pwd)/metrics.log:/app/metrics.log metrics-collector
```

### Просмотр логов
```bash
docker logs metrics-collector
```

### Запуск тестов в контейнере
```bash
docker run metrics-collector ./run_tests
```

### Запуск бенчмарков в контейнере
```bash
docker run metrics-collector ./BenchmarkTest
```
